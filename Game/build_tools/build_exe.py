"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–≥—Ä—ã.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PyInstaller –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è .exe —Ñ–∞–π–ª–∞ –∏–∑ Python-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
–í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
"""

import os
import sys
import subprocess
import shutil
from pathlib import Path


def build_exe():
    """–°–±–æ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–≥—Ä—ã."""

    print("üéÆ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞...")

    # –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫
    if os.path.exists("build"):
        shutil.rmtree("build")
    if os.path.exists("dist"):
        shutil.rmtree("dist")
    if os.path.exists("game.spec"):
        os.remove("game.spec")

    # –ö–æ–º–∞–Ω–¥–∞ PyInstaller
    cmd = [
        "pyinstaller",
        "--onefile",  # –û–¥–∏–Ω —Ñ–∞–π–ª
        "--windowed",  # –ë–µ–∑ –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        "--name=–ü–∞–¥–µ–Ω–∏–µ_–ú–µ—á–∞",  # –ò–º—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
        "--icon=assets/images/icons/icon_1.jpg",  # –ò–∫–æ–Ω–∫–∞
        "--add-data=assets;assets",  # –í–∫–ª—é—á–∏—Ç—å –ø–∞–ø–∫—É assets
        "--add-data=userdata;userdata",  # –í–∫–ª—é—á–∏—Ç—å –ø–∞–ø–∫—É userdata
        "--add-data=dialogues;dialogues",  # –í–∫–ª—é—á–∏—Ç—å –ø–∞–ø–∫—É dialogues
        "--hidden-import=pygame",  # –Ø–≤–Ω–æ –≤–∫–ª—é—á–∏—Ç—å pygame
        "--hidden-import=pygame.mixer",  # –í–∫–ª—é—á–∏—Ç—å pygame.mixer
        "--hidden-import=json",  # –í–∫–ª—é—á–∏—Ç—å json
        "--hidden-import=time",  # –í–∫–ª—é—á–∏—Ç—å time
        "--hidden-import=os",  # –í–∫–ª—é—á–∏—Ç—å os
        "--hidden-import=sys",  # –í–∫–ª—é—á–∏—Ç—å sys
        "--hidden-import=pathlib",  # –í–∫–ª—é—á–∏—Ç—å pathlib
        "--clean",  # –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
        "--noconfirm",  # –ù–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        "game.py"  # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª
    ]

    try:
        # –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏
        print("üî® –ó–∞–ø—É—Å–∫ PyInstaller...")
        result = subprocess.run(cmd, check=True, capture_output=True, text=True)
        print("‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        exe_path = Path("dist/–ü–∞–¥–µ–Ω–∏–µ_–ú–µ—á–∞.exe")
        if exe_path.exists():
            print(f"üéâ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: {exe_path}")
            print(f"üìÅ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {exe_path.stat().st_size / (1024 * 1024):.1f} MB")
        else:
            print("‚ùå –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!")

    except subprocess.CalledProcessError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ: {e}")
        print(f"–í—ã–≤–æ–¥ –æ—à–∏–±–∫–∏: {e.stderr}")
        return False
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return False

    return True


def create_installer():
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞."""

    print("\nüì¶ –°–æ–∑–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞...")

    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
    installer_dir = Path("installer")
    installer_dir.mkdir(exist_ok=True)

    # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
    exe_source = Path("dist/–ü–∞–¥–µ–Ω–∏–µ_–ú–µ—á–∞.exe")
    exe_dest = installer_dir / "–ü–∞–¥–µ–Ω–∏–µ_–ú–µ—á–∞.exe"

    if exe_source.exists():
        shutil.copy2(exe_source, exe_dest)
        print(f"‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ {installer_dir}")

        # –°–æ–∑–¥–∞–Ω–∏–µ README –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
        readme_content = """# –ü–∞–¥–µ–Ω–∏–µ –ú–µ—á–∞ - –£—Å—Ç–∞–Ω–æ–≤–∫–∞

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–≥—Ä—ã

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª "–ü–∞–¥–µ–Ω–∏–µ_–ú–µ—á–∞.exe" –≤ –ª—é–±—É—é –ø–∞–ø–∫—É
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –¥–≤–æ–π–Ω—ã–º —â–µ–ª—á–∫–æ–º
3. –ò–≥—Ä–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Windows 7/8/10/11
- –ú–∏–Ω–∏–º—É–º 2 GB RAM
- 500 MB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

- WASD - –î–≤–∏–∂–µ–Ω–∏–µ
- E - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
- ESC - –ú–µ–Ω—é
- –ú—ã—à—å - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É:
- VK: https://vk.com/sergeyoshepkov
- Email: Oshchepkov.Sergey@urfu.me

–£–¥–∞—á–Ω–æ–π –∏–≥—Ä—ã!
"""

        with open(installer_dir / "README.txt", "w", encoding="utf-8") as f:
            f.write(readme_content)

        print("‚úÖ README —Å–æ–∑–¥–∞–Ω")
        print(f"üìÅ –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –≥–æ—Ç–æ–≤ –≤ –ø–∞–ø–∫–µ: {installer_dir}")

    else:
        print("‚ùå –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!")


if __name__ == "__main__":
    print("‚öîÔ∏è –°–±–æ—Ä–∫–∞ –∏–≥—Ä—ã '–ü–∞–¥–µ–Ω–∏–µ –ú–µ—á–∞'")
    print("=" * 50)

    # –°–±–æ—Ä–∫–∞ .exe
    if build_exe():
        # –°–æ–∑–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
        create_installer()
        print("\nüéâ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é.")
    else:
        print("\n‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ.")
